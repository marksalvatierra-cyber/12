<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RizAlert - Edit Emergency</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <link rel="stylesheet" href="/static/css/sidebar.css">
    <!-- NEW: modern styles + red gradient button -->
    <style>

         /* Badges */
        .badge { border-radius: 999px; padding: .35rem .6rem; font-weight: 700; display:inline-flex; align-items:center; gap:8px; }
        .badge-error { background: linear-gradient(90deg, rgba(255, 255, 255, 1), rgba(240, 240, 240, 1)); color: #000000ff; }
        .badge-info { background: linear-gradient(90deg, rgba(37,99,235,0.12), rgba(37,99,235,0.06)); color: #1e40af; }
        .badge-warning { background: linear-gradient(90deg, rgba(255, 255, 255, 1), rgba(240, 240, 240, 1)); color: #000000ff; }
        .badge-success { background: linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06)); color: #065f46; }
        .badge-ghost { background: rgba(15,23,42,0.03); color: var(--muted); }

        /* Modern card / form refinements (scoped) */
        .card.bg-base-100 {
            background: linear-gradient(180deg,#ffffff,#fbfbfd);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15,23,42,0.06);
            border: 1px solid rgba(15,23,42,0.04);
        }
        .card-body { padding: 1.25rem; }
        h2.card-title { font-weight:700; color:#0f172a; }

        .form-control .label-text { color: #374151; font-weight:600; }
        .input.input-bordered, .textarea.textarea-bordered, .select.select-bordered {
            border-radius: 8px;
            border: 1px solid rgba(15,23,42,0.08);
            background: #ffffff;
            padding: .6rem .75rem;
            box-shadow: none;
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(59,130,246,0.08);
            border-color: rgba(59,130,246,0.9);
        }

        /* Red gradient save button */
        .btn-gradient-red {
            background: linear-gradient(90deg,#ef4444 0%, #b91c1c 100%);
            color: #fff;
            border: none;
            box-shadow: 0 8px 30px rgba(185,28,28,0.12);
            transition: transform .12s ease, box-shadow .12s ease;
        }
        .btn-gradient-red:hover, .btn-gradient-red:focus {
            transform: translateY(-2px);
            box-shadow: 0 14px 36px rgba(185,28,28,0.18);
        }

        /* Small responsive tweaks */
        @media (max-width: 768px) {
            .card-body { padding: .9rem; }
            .stat-title, .label-text { font-size: .95rem; }
        }
    </style>
</head>
<body class="bg-base-200">
    <div class="drawer lg:drawer-open">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        <!-- Main Content -->
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-red-900 shadow-lg">
                <div class="flex-none lg:hidden">
                    <label for="drawer-toggle" class="btn btn-square btn-ghost">
                        <i class="fas fa-bars text-white text-xl"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <h1 class="text-xl font-bold text-white">Edit Emergency</h1>
                </div>
                <div class="flex-none">
                    <a href="/emergencies" class="btn btn-ghost text-white hover:bg-red-600" style="color:white;">
    <i class="fas fa-arrow-left mr-2"></i>Back to Emergencies
                    </a>
                </div>
            </div>
            
            <!-- Edit Emergency Content -->
            <div class="p-6">
                <!-- Emergency Edit Form -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">
                            <i class="fas fa-edit text-primary"></i>
                            Edit Emergency Details
                        </h2>
                        
                        <form id="editEmergencyForm" onsubmit="submitEdit(event)">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Basic Information -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold">Basic Information</h3>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Emergency Type *</span>
                                        </label>
                                        <select name="case_type" class="select select-bordered" required>
                                            {% for case_type in case_types %}
                                            <option value="{{ case_type.name }}" {{ 'selected' if emergency.case_type.value == case_type.value else '' }}>
                                                {{ case_type.value }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Status *</span>
                                        </label>
                                        <select name="status" class="select select-bordered" required>
                                            {% for status in statuses %}
                                            <option value="{{ status.name }}" {{ 'selected' if emergency.status.value == status.value else '' }}>
                                                {{ status.value }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Active Status</span>
                                        </label>
                                        <label class="label cursor-pointer justify-start gap-2">
                                            <input type="checkbox" name="isActive" class="checkbox" {{ 'checked' if emergency.isActive else '' }} />
                                            <span class="label-text">Emergency is currently active</span>
                                        </label>
                                    </div>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Emergency Message</span>
                                        </label>
                                        <textarea name="message" class="textarea textarea-bordered h-32" placeholder="Describe the emergency situation...">{{ emergency.message or '' }}</textarea>
                                    </div>
                                </div>
                                
                                <!-- Location Information -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-semibold">Location Information</h3>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Location Description</span>
                                        </label>
                                        <input type="text" name="location_text" value="{{ emergency.location_text or '' }}" placeholder="e.g., Near City Hall, Main Street" class="input input-bordered" />
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">Latitude</span>
                                            </label>
                                            <input type="number" name="latitude" value="{{ emergency.latitude or '' }}" step="any" placeholder="14.5995" class="input input-bordered" />
                                        </div>
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">Longitude</span>
                                            </label>
                                            <input type="number" name="longitude" value="{{ emergency.longitude or '' }}" step="any" placeholder="121.0308" class="input input-bordered" />
                                        </div>
                                    </div>
                                    
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Image/File URL</span>
                                        </label>
                                        <input type="url" name="file_id" value="{{ emergency.file_id or '' }}" placeholder="https://example.com/image.jpg" class="input input-bordered" />
                                        <label class="label">
                                            <span class="label-text-alt">URL to emergency image or document</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Information Display -->
                            <div class="divider">Current Information</div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <div><strong>Reporter:</strong> {{ emergency.user.fullName }} (@{{ emergency.user.username }})</div>
                                    <div><strong>Created:</strong> {{ emergency.created_at.strftime('%Y-%m-%d %H:%M:%S') if emergency.created_at else 'Unknown' }}</div>
                                    <div><strong>Emergency ID:</strong> {{ emergency.id }}</div>
                                </div>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="card-actions justify-end mt-6">
                                <a href="/emergencies/{{ emergency.id }}" class="btn btn-outline">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-gradient-red">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar (modern) -->
        <div class="drawer-side">
            <label for="drawer-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-64 sidebar-modern">
                <div class="p-4">
                    <div class="sidebar-profile">
                        <div class="avatar">
                            <img alt="{{ current_user.fullName if current_user else 'Admin' }}" src="{{ current_user.profile_picture if current_user else 'https://api.dicebear.com/7.x/avataaars/svg?seed=admin' }}" />
                        </div>
                        <div class="meta">
                            <div class="name">{{ current_user.fullName if current_user else 'Administrator' }}</div>
                            <div class="sub">{{ current_user.email if current_user else 'admin@local' }}</div>
                        </div>
                    </div>
                    <ul class="menu p-0 w-full">
                        <li><a href="/" class="nav-link"><i class="fas fa-home nav-icon"></i><span>Home</span></a></li>
                        <li><a href="/users" class=" nav-link"><i class="fas fa-users nav-icon"></i><span>Users</span></a></li>
                        <li><a href="/reports" class="nav-link"><i class="fas fa-chart-bar nav-icon"></i><span>Reports</span></a></li>
                        <li><a href="/sirens" class="nav-link"><i class="fas fa-volume-up nav-icon"></i><span>IoT Siren</span></a></li>
                        <li class="menu-title text-white">Emergency</li>
                        <li><a href="/emergencies" class="active nav-link"><i class="fas fa-exclamation-triangle nav-icon"></i><span>Emergencies</span></a></li>
                        <li><a href="/alerts" class=" nav-link"><i class="fas fa-bullhorn nav-icon"></i><span>Emergency Alerts</span></a></li>
                        <li><a href="/map" class=" nav-link"><i class="fas fa-map-marked-alt nav-icon"></i><span>Incident Map</span></a></li>
                        <li><a href="/weather" class=" nav-link"><i class="fas fa-cloud-sun nav-icon"></i><span>Weather Map</span></a></li>
                        <li class="menu-title text-white">Settings</li>
                        <li><a href="javascript:void(0)" onclick="showNotifications()" class="nav-link"><i class="fas fa-bell nav-icon"></i><span>Notifications</span></a></li>
                        <li><a href="/configuration" class="nav-link"><i class="fas fa-cog nav-icon"></i><span>Configuration</span></a></li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</div>

    <script>
        function submitEdit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                case_type: formData.get('case_type'),
                status: formData.get('status'),
                message: formData.get('message'),
                location_text: formData.get('location_text'),
                file_id: formData.get('file_id'),
                isActive: formData.has('isActive')
            };
            
            // Add coordinates if provided
            const latitude = formData.get('latitude');
            const longitude = formData.get('longitude');
            if (latitude && longitude) {
                data.latitude = parseFloat(latitude);
                data.longitude = parseFloat(longitude);
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            
            fetch(`/api/emergencies/{{ emergency.id }}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                alert('Emergency updated successfully!');
                window.location.href = `/emergencies/{{ emergency.id }}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update emergency: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        }
    </script>
    <script src="/static/js/notifications.js"></script>
</body>
</html>