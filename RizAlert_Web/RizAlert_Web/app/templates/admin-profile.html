<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RizAlert - Admin Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- load centralized sidebar CSS -->
    <link rel="stylesheet" href="/static/css/sidebar.css">

</head>
<body class="bg-base-200">
    <div class="drawer lg:drawer-open">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        <!-- Main Content -->
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-red-900 shadow-lg">
                <div class="flex-none lg:hidden">
                    <label for="drawer-toggle" class="btn btn-square btn-ghost">
                        <i class="fas fa-bars text-white text-xl"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <h1 class="text-xl font-bold text-white">Admin Profile</h1>
                </div>
                <div class="flex-none">
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                            <div class="w-10 rounded-full">
                                <img alt="{{ admin.fullName if admin else 'Admin' }}" src="{{ admin.profile_picture if admin else 'https://api.dicebear.com/7.x/avataaars/svg?seed=admin' }}" />
                            </div>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a href="/admin/profile" class="active"><i class="fas fa-user mr-2"></i>Profile</a></li>
                            <li><a href="/admin/logout"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Profile Content -->
            <div class="p-6">
                <!-- 2FA Setup Warning (First-time setup) -->
                {% if admin.two_factor_enabled == False %}
                <div class="alert alert-warning shadow-lg mb-6">
                    <div>
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                        <div>
                            <h3 class="font-bold">Two-Factor Authentication Required</h3>
                            <div class="text-sm">Please enable 2FA to secure your admin account. Go to the Security tab below and click "Enable 2FA".</div>
                        </div>
                    </div>
                    <div class="flex-none">
                        <button class="btn btn-sm btn-warning" onclick="document.querySelector('input[aria-label=Security]').click()">
                            Setup Now
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Profile Header Card -->
                <div class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="avatar">
                                <div class="w-32 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                                    <img src="{{ admin.profile_picture }}" alt="Profile Picture" />
                                </div>
                            </div>
                            <div class="flex-1 text-center md:text-left">
                                <h2 class="text-3xl font-bold">{{ admin.fullName }}</h2>
                                <p class="text-base-content/70">@{{ admin.username }}</p>
                                <div class="flex flex-wrap gap-2 mt-4 justify-center md:justify-start">
                                    <div class="badge badge-primary badge-lg">
                                        <i class="fas fa-shield-alt mr-2"></i>{{ admin.role }}
                                    </div>
                                    <div class="badge badge-secondary badge-lg">
                                        <i class="fas fa-building mr-2"></i>{{ admin.department }}
                                    </div>
                                    {% if admin.two_factor_enabled %}
                                    <div class="badge badge-success badge-lg">
                                        <i class="fas fa-lock mr-2"></i>2FA Enabled
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-primary" onclick="document.getElementById('upload-photo').click()">
                                    <i class="fas fa-camera mr-2"></i>Change Photo
                                </button>
                                <input type="file" id="upload-photo" class="hidden" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tabs -->
                <div role="tablist" class="tabs tabs-lifted tabs-lg">
                    <!-- Personal Information Tab -->
                    <input type="radio" name="profile_tabs" role="tab" class="tab" aria-label="Personal" checked />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <h3 class="text-2xl font-bold mb-6">
                            <i class="fas fa-user-circle mr-2 text-primary"></i>Personal Information
                        </h3>
                        <form id="personal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Full Name</span>
                                </label>
                                <input type="text" id="fullName" value="{{ admin.fullName }}" class="input input-bordered" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Username</span>
                                </label>
                                <input type="text" id="username" value="{{ admin.username }}" class="input input-bordered" readonly />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Role</span>
                                </label>
                                <input type="text" value="{{ admin.role }}" class="input input-bordered" readonly />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Department</span>
                                </label>
                                <input type="text" id="department" value="{{ admin.department }}" class="input input-bordered" />
                            </div>
                            <div class="form-control md:col-span-2">
                                <label class="label">
                                    <span class="label-text">Address</span>
                                </label>
                                <textarea id="address" class="textarea textarea-bordered h-24">{{ admin.address }}</textarea>
                            </div>
                            <div class="form-control md:col-span-2">
                                <button type="button" class="btn btn-primary" onclick="updateProfile('personal')">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Contact Information Tab -->
                    <input type="radio" name="profile_tabs" role="tab" class="tab" aria-label="Contact" />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <h3 class="text-2xl font-bold mb-6">
                            <i class="fas fa-address-book mr-2 text-primary"></i>Contact Information
                        </h3>
                        <form id="contact-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Email Address</span>
                                </label>
                                <input type="email" id="email" value="{{ admin.email }}" class="input input-bordered" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Phone Number</span>
                                </label>
                                <input type="tel" id="phone" value="{{ admin.phone }}" class="input input-bordered" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Emergency Contact</span>
                                </label>
                                <input type="tel" id="emergencyPhone" value="{{ admin.emergencyPhone }}" placeholder="+63 XXX XXX XXXX" class="input input-bordered" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Emergency Contact Name</span>
                                </label>
                                <input type="text" id="emergencyName" value="{{ admin.emergencyName }}" placeholder="Contact person name" class="input input-bordered" />
                            </div>
                            <div class="form-control md:col-span-2">
                                <button type="button" class="btn btn-primary" onclick="updateProfile('contact', event)">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Account & Security Tab -->
                    <input type="radio" name="profile_tabs" role="tab" class="tab" aria-label="Security" />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <h3 class="text-2xl font-bold mb-6">
                            <i class="fas fa-shield-alt mr-2 text-primary"></i>Account & Security
                        </h3>
                        
                        <!-- Account Information -->
                        <div class="card bg-base-200 mb-6">
                            <div class="card-body">
                                <h4 class="card-title text-lg">Account Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-base-content/70">Account Created</p>
                                        <p class="font-semibold">{{ admin.joined_date }}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-base-content/70">Last Login</p>
                                        <p class="font-semibold">{{ admin.last_login }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Change Password -->
                        <div class="card bg-base-200 mb-6">
                            <div class="card-body">
                                <h4 class="card-title text-lg">Change Password</h4>
                                <form class="space-y-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Current Password</span>
                                        </label>
                                        <input type="password" id="currentPassword" placeholder="Enter current password" class="input input-bordered" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">New Password</span>
                                        </label>
                                        <input type="password" id="newPassword" placeholder="Enter new password" class="input input-bordered" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Confirm New Password</span>
                                        </label>
                                        <input type="password" id="confirmPassword" placeholder="Confirm new password" class="input input-bordered" />
                                    </div>
                                    <button type="button" class="btn btn-warning" onclick="updateProfile('account', event)">
                                        <i class="fas fa-key mr-2"></i>Update Password
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Two-Factor Authentication -->
                        <div class="card bg-base-200">
                            <div class="card-body">
                                <h4 class="card-title text-lg">Two-Factor Authentication (2FA)</h4>
                                <p class="text-sm text-base-content/70 mb-4">
                                    Add an extra layer of security to your account by enabling two-factor authentication.
                                </p>
                                
                                {% if admin.two_factor_enabled %}
                                <div class="alert alert-success mb-4">
                                    <i class="fas fa-check-circle"></i>
                                    <span>2FA is currently enabled on your account</span>
                                </div>
                                <button class="btn btn-error" onclick="disable2FA()">
                                    <i class="fas fa-times mr-2"></i>Disable 2FA
                                </button>
                                {% else %}
                                <div class="alert alert-warning mb-4">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>2FA is not enabled. Enable it to secure your account.</span>
                                </div>
                                <button class="btn btn-success" onclick="setup2FA()">
                                    <i class="fas fa-mobile-alt mr-2"></i>Enable 2FA
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="drawer-side">
            <label for="drawer-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-64 sidebar-modern">
                <div class="p-4">
                    <div class="sidebar-profile">
                        <div class="avatar">
                            <img alt="{{ admin.fullName if admin else 'Admin' }}" src="{{ admin.profile_picture if admin else 'https://api.dicebear.com/7.x/avataaars/svg?seed=admin' }}" />
                        </div>
                        <div class="meta">
                            <div class="name">{{ admin.fullName if admin else 'Administrator' }}</div>
                            <div class="sub">{{ admin.email if admin else 'admin@local' }}</div>
                        </div>
                    </div>
                    <ul class="menu p-0 w-full">
                        <li><a href="/" class="active nav-link"><i class="fas fa-home nav-icon"></i><span>Home</span></a></li>
                        <li><a href="/users" class="nav-link"><i class="fas fa-users nav-icon"></i><span>Users</span></a></li>
                        <li><a href="/reports" class="nav-link"><i class="fas fa-chart-bar nav-icon"></i><span>Reports</span></a></li>
                        <li><a href="/sirens" class="nav-link"><i class="fas fa-volume-up nav-icon"></i><span>IoT Siren</span></a></li>
                        <li class="menu-title text-white">Emergency</li>
                        <li><a href="/emergencies" class="nav-link"><i class="fas fa-exclamation-triangle nav-icon"></i><span>Emergencies</span></a></li>
                        <li><a href="/alerts" class="nav-link"><i class="fas fa-bullhorn nav-icon"></i><span>Emergency Alerts</span></a></li>
                        <li><a href="/map" class="nav-link"><i class="fas fa-map-marked-alt nav-icon"></i><span>Incident Map</span></a></li>
                        <li><a href="/weather" class="nav-link"><i class="fas fa-cloud-sun nav-icon"></i><span>Weather Map</span></a></li>
                        <li class="menu-title text-white">Settings</li>
                        <li><a href="javascript:void(0)" onclick="showNotifications()" class="nav-link"><i class="fas fa-bell nav-icon"></i><span>Notifications</span></a></li>
                        <li><a href="/configuration" class="nav-link"><i class="fas fa-cog nav-icon"></i><span>Configuration</span></a></li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <dialog id="twoFactorModal" class="modal">
        <div class="modal-box max-w-md">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-mobile-alt mr-2"></i>Enable Two-Factor Authentication
            </h3>
            <div id="twoFactorContent">
                <p class="mb-4">Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>
                <div class="flex justify-center mb-4">
                    <img id="qrCode" src="" alt="QR Code" class="w-64 h-64">
                </div>
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Or enter this code manually:</span>
                    </label>
                    <input type="text" id="secretKey" readonly class="input input-bordered" />
                </div>
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Enter verification code from your app:</span>
                    </label>
                    <input type="text" id="verifyCode" placeholder="000000" maxlength="6" class="input input-bordered" />
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="verify2FA()">
                    <i class="fas fa-check mr-2"></i>Verify & Enable
                </button>
                <button class="btn" onclick="document.getElementById('twoFactorModal').close()">Cancel</button>
            </div>
        </div>
    </dialog>

    <!-- Disable 2FA Modal -->
    <dialog id="disable2FAModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>Disable Two-Factor Authentication
            </h3>
            <p class="mb-4">Enter your current 2FA code to disable two-factor authentication:</p>
            <div class="form-control mb-4">
                <input type="text" id="disable2FACode" placeholder="000000" maxlength="6" class="input input-bordered" />
            </div>
            <div class="modal-action">
                <button class="btn btn-error" onclick="confirmDisable2FA()">
                    <i class="fas fa-times mr-2"></i>Disable 2FA
                </button>
                <button class="btn" onclick="document.getElementById('disable2FAModal').close()">Cancel</button>
            </div>
        </div>
    </dialog>

    <script>
        async function updateProfile(type, event) {
            let formData = {};
            
            // Get the button that was clicked and show loading state
            const button = event ? event.target : document.querySelector(`button[onclick*="updateProfile('${type}')"]`);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            
            try {
                if (type === 'personal') {
                    const fullName = document.getElementById('fullName').value.trim();
                    const department = document.getElementById('department').value.trim();
                    const address = document.getElementById('address').value.trim();
                    
                    if (!fullName) {
                        alert('Full name is required');
                        return;
                    }
                    
                    formData = {
                        type: type,
                        fullName: fullName,
                        department: department,
                        address: address
                    };
                } else if (type === 'contact') {
                    const email = document.getElementById('email').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    
                    if (!email) {
                        alert('Email is required');
                        return;
                    }
                    
                    // Basic email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('Please enter a valid email address');
                        return;
                    }
                    
                    formData = {
                        type: type,
                        email: email,
                        phone: phone,
                        emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
                        emergencyName: document.getElementById('emergencyName').value.trim()
                    };
                } else if (type === 'account') {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        alert('Please fill in all password fields');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        alert('New password and confirmation do not match');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        alert('New password must be at least 6 characters long');
                        return;
                    }
                    
                    formData = {
                        type: type,
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    };
                }

                console.log('Sending update request:', {
                    url: '/admin/profile/update',
                    method: 'POST',
                    data: formData
                });

                const response = await fetch('/admin/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Update response:', data);

                if (data.success) {
                    alert('✅ ' + data.message);
                    // Clear password fields after successful password change
                    if (type === 'account') {
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                    }
                    // Reload the page to show updated information for personal/contact changes
                    if (type === 'personal' || type === 'contact') {
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } else {
                    alert('❌ Error: ' + (data.error || data.message || 'Unknown error occurred'));
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('❌ Error: Failed to update profile. Please check your connection and try again.');
            } finally {
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function setup2FA() {
            try {
                const response = await fetch('/admin/2fa/setup');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('qrCode').src = data.qr_code;
                    document.getElementById('secretKey').value = data.secret;
                    document.getElementById('twoFactorModal').showModal();
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        async function verify2FA() {
            const code = document.getElementById('verifyCode').value;
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-digit code');
                return;
            }

            try {
                const response = await fetch('/admin/2fa/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (data.success) {
                    alert('✅ ' + data.message);
                    document.getElementById('twoFactorModal').close();
                    window.location.reload();
                } else {
                    alert('❌ ' + data.error);
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        function disable2FA() {
            document.getElementById('disable2FAModal').showModal();
        }

        async function confirmDisable2FA() {
            const code = document.getElementById('disable2FACode').value;
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-digit code');
                return;
            }

            try {
                const response = await fetch('/admin/2fa/disable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (data.success) {
                    alert('✅ ' + data.message);
                    document.getElementById('disable2FAModal').close();
                    window.location.reload();
                } else {
                    alert('❌ ' + data.error);
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        // Profile Picture Upload Functionality
        document.getElementById('upload-photo').addEventListener('change', handleProfilePictureUpload);

        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('❌ Please select a valid image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('❌ Image size must be less than 5MB');
                return;
            }

            try {
                // Show loading state
                const avatarImg = document.querySelector('.avatar img');
                const originalSrc = avatarImg.src;
                avatarImg.style.opacity = '0.5';

                // Create FormData for file upload
                const formData = new FormData();
                formData.append('profile_picture', file);

                const response = await fetch('/admin/profile/upload-picture', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Update the profile picture display
                    avatarImg.src = data.picture_url;
                    avatarImg.style.opacity = '1';
                    alert('✅ Profile picture updated successfully!');
                } else {
                    avatarImg.style.opacity = '1';
                    alert('❌ Error: ' + (data.error || 'Failed to upload picture'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.querySelector('.avatar img').style.opacity = '1';
                alert('❌ Error: Failed to upload profile picture. Please try again.');
            }

            // Clear the file input
            event.target.value = '';
        }
    </script>
    <script src="/static/js/notifications.js"></script>
</body>
</html>
